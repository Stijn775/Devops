#!/usr/bin/env bash
set -e
 
CONTAINER_NAME="jenkins_server"
VOLUME_NAME="jenkins-data"
IMAGE="jenkins/jenkins:lts-jdk17"
 
echo " Stopping existing Jenkins container (if any)..."
docker rm -f $CONTAINER_NAME 2>/dev/null || true
 
echo " Fixing permissions on Jenkins volume..."
docker run --rm \
  -v ${VOLUME_NAME}:/var/jenkins_home \
  busybox \
  chown -R 1000:1000 /var/jenkins_home
 
echo " Starting Jenkins with safe limits..."
 
docker run -d \
  --name $CONTAINER_NAME \
  -p 8080:8080 \
  --pids-limit=-1 \
  --ulimit nproc=65535:65535 \
  --ulimit nofile=65535:65535 \
  --security-opt seccomp=unconfined \
  -v ${VOLUME_NAME}:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v "$(which docker)":/usr/bin/docker \
  $IMAGE
 
echo " Jenkins is starting!"
echo " Open: http://localhost:8080/"